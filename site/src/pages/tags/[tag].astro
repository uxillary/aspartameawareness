---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const tags = new Set<string>();
  for (const p of posts) for (const t of (p.data.tags||[])) tags.add(String(t).toLowerCase());
  return Array.from(tags).map(tag => ({ params: { tag } }));
}

const { tag } = Astro.params;
const all = (await getCollection("posts")).filter(p =>
  (p.data.tags||[]).map(t=>String(t).toLowerCase()).includes(String(tag).toLowerCase())
).sort((a,b) => (new Date(b.data.publishDate||0)) - (new Date(a.data.publishDate||0)));

const title = `Tag: ${tag}`;
const description = `Articles tagged ${tag}.`;
---

<BaseLayout {title} {description}>
  <main id="main" class="mx-auto max-w-3xl px-4 py-10">
    <h1 class="text-3xl font-semibold mb-6">{title}</h1>
    <ul class="space-y-5">
      {all.map(({ data, slug }) => (
        <li>
          <a class="underline underline-offset-4 font-medium" href={`/blog/${slug}`}>{data.title}</a>
          {data.description && <p class="text-sm mt-1">{data.description}</p>}
        </li>
      ))}
    </ul>
  </main>
</BaseLayout>
